{
  "version": 3,
  "sources": ["render-pages.ts"],
  "sourcesContent": ["import * as esbuild from \"esbuild\"\nimport * as fs from \"fs/promises\"\nimport * as path from \"path\"\nimport * as React from \"react\"\nimport * as ReactDOMServer from \"react-dom/server\"\nimport * as types from \"./types\"\n\n// prettier-ignore\ninterface Meta {\n\tfs_path: string // Filesystem path\n\tpath:    string\n\tprops?:  types.ResolvedProps\n\texports: types.StaticPage | types.DynamicPage\n}\n\nconst resolvedRouter: types.ResolvedPaths = {}\n\nasync function renderPage(runtime: types.Runtime, meta: Meta) {\n\tlet head = \"<!-- <Head {...resolvedProps}> -->\"\n\tif (typeof meta.exports.Head === \"function\") {\n\t\t// TODO: Warn on non-functions.\n\t\thead = ReactDOMServer.renderToStaticMarkup(React.createElement(meta.exports.Head, meta.props))\n\t}\n\n\tlet page = \"<!-- <Head {...resolvedProps}> -->\"\n\t// TODO: Warn on non-functions.\n\tpage = ReactDOMServer.renderToString(React.createElement(meta.exports.default, meta.props))\n\n\t// prettier-ignore\n\tconst html = runtime.base_page\n\t\t.replace(\"%head%\", head\n\t\t\t.replace(/></g, \">\\n\\t\\t<\")\n\t\t\t.replace(/\\/>/g, \" />\"),\n\t\t)\n\t\t.replace(\"%page%\", `<noscript>You need to enable JavaScript to run this app.</noscript>\n\t\t<div id=\"root\">${page}</div>\n\t\t<script src=\"/app.js\"></script>`)\n\n\tawait fs.writeFile(meta.fs_path, html)\n}\n\nasync function run(runtime: types.Runtime) {\n\tconst service = await esbuild.startService()\n\n\ttry {\n\t\t// TODO: Upgrade to Promise.all (maybe add --concurrent?).\n\t\tfor (const route of runtime.page_based_router) {\n\t\t\tconst src = route.src_path\n\t\t\tconst src_esbuild = path.join(runtime.dir_config.cache_dir, src.replace(/\\.(jsx?|tsx?)$/, \".esbuild.$1\"))\n\t\t\tconst dst = src\n\t\t\t\t.replace(runtime.dir_config.pages_dir, runtime.dir_config.build_dir)\n\t\t\t\t.replace(/\\.(jsx?|tsx?)$/, \".html\")\n\n\t\t\tawait service.build({\n\t\t\t\tbundle: true,\n\t\t\t\tdefine: {\n\t\t\t\t\t__DEV__: \"true\",\n\t\t\t\t\t\"process.env.NODE_ENV\": JSON.stringify(\"development\"),\n\t\t\t\t},\n\t\t\t\tentryPoints: [src],\n\t\t\t\t// NOTE: Use \"external\" to prevent a React error: You might have\n\t\t\t\t// mismatching versions of React and the renderer (such as React DOM).\n\t\t\t\texternal: [\"react\", \"react-dom\"],\n\t\t\t\tformat: \"cjs\",\n\t\t\t\tloader: {\n\t\t\t\t\t\".js\": \"jsx\",\n\t\t\t\t},\n\t\t\t\tlogLevel: \"silent\", // TODO\n\t\t\t\toutfile: src_esbuild,\n\t\t\t\t// plugins: [...configs.retro.plugins],\n\t\t\t})\n\t\t\t// TODO: Handle warnings and hints.\n\n\t\t\tconst exports = require(\"../\" + src_esbuild)\n\n\t\t\t// TODO: Add cache check here.\n\n\t\t\tlet resolvedProps: types.ResolvedProps\n\t\t\tif (typeof exports.serverProps === \"function\") {\n\t\t\t\tprops = await exports.serverProps()\n\t\t\t}\n\n\t\t\tif (typeof exports.serverPaths === \"function\") {\n\t\t\t\tconst resolvedPathsArray: types.ResolvedPathsArray = await exports.serverPaths(props)\n\t\t\t\tconst routeInfos = resolvedPathsArray.reduce<types.ResolvedPaths>((accum, each) => {\n\t\t\t\t\taccum[each.path] = {\n\t\t\t\t\t\troute,\n\t\t\t\t\t\tprops: each.props,\n\t\t\t\t\t}\n\t\t\t\t\treturn accum\n\t\t\t\t}, {})\n\n\t\t\t\tif (routeInfos !== undefined) {\n\t\t\t\t\tfor (const [path_, routeInfo] of Object.entries(routeInfos)) {\n\t\t\t\t\t\t// TODO: Warn here for repeat paths.\n\t\t\t\t\t\tconst decoratedProps = { path: path_, ...routeInfo.props }\n\t\t\t\t\t\tresolvedRouter[path_] = { route, props: decoratedProps }\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfor (const [path_, routeInfo] of Object.entries(routeInfos)) {\n\t\t\t\t\tconst fs_path = path.join(runtime.dir_config.build_dir, path_) + \".html\"\n\t\t\t\t\tconst decoratedProps = { path: path_, ...routeInfo.props }\n\t\t\t\t\tconst meta: Meta = { fs_path, path: path_, props: decoratedProps, exports }\n\t\t\t\t\tawait renderPage(runtime, meta)\n\t\t\t\t}\n\t\t\t\tcontinue\n\t\t\t}\n\n\t\t\t// TODO: Warn here for repeat paths.\n\t\t\tconst path_ = route.path\n\t\t\tconst decoratedProps = { path: path_, ...resolvedProps }\n\t\t\tresolvedRouter[path_] = { route, props: decoratedProps }\n\n\t\t\tconst meta: Meta = { fs_path: dst, path: route.path, props: decoratedProps, exports }\n\t\t\tawait renderPage(runtime, meta)\n\t\t}\n\n\t\t// Cache resolvedRouter for --cached:\n\t\tconst resolvedRouterPath = path.join(runtime.dir_config.cache_dir, \"resolvedRouter.json\")\n\t\tawait fs.writeFile(resolvedRouterPath, JSON.stringify(resolvedRouter, null, \"\\t\") + \"\\n\")\n\t} catch (err) {\n\t\t// console.error(err.message)\n\t\tthrow err\n\t\tprocess.exit(1)\n\t}\n}\n\nrun(require(\"../__cache__/runtime.json\"))\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;AAAA,cAAyB;AACzB,SAAoB;AACpB,WAAsB;AACtB,YAAuB;AACvB,qBAAgC;AAWhC,MAAM,iBAAsC;AAE5C,0BAA0B,SAAwB;AACjD,MAAI,OAAO;AACX,MAAI,OAAO,KAAK,QAAQ,SAAS;AAEhC,WAAO,eAAe,qBAAqB,MAAM,cAAc,KAAK,QAAQ,MAAM,KAAK;AAAA;AAGxF,MAAI,OAAO;AAEX,SAAO,eAAe,eAAe,MAAM,cAAc,KAAK,QAAQ,SAAS,KAAK;AAGpF,QAAM,OAAO,QAAQ,UACnB,QAAQ,UAAU,KACjB,QAAQ,OAAO,UACf,QAAQ,QAAQ,QAEjB,QAAQ,UAAU;AAAA,mBACF;AAAA;AAGlB,QAAM,GAAG,UAAU,KAAK,SAAS;AAAA;AAGlC,mBAAmB;AAClB,QAAM,UAAU,MAAM,QAAQ;AAE9B;AAEC,eAAW,SAAS,QAAQ;AAC3B,YAAM,MAAM,MAAM;AAClB,YAAM,cAAc,KAAK,KAAK,QAAQ,WAAW,WAAW,IAAI,QAAQ,kBAAkB;AAC1F,YAAM,MAAM,IACV,QAAQ,QAAQ,WAAW,WAAW,QAAQ,WAAW,WACzD,QAAQ,kBAAkB;AAE5B,YAAM,QAAQ,MAAM;AAAA,QACnB,QAAQ;AAAA,QACR,QAAQ;AAAA,UACP,SAAS;AAAA,UACT,wBAAwB,KAAK,UAAU;AAAA;AAAA,QAExC,aAAa,CAAC;AAAA,QAGd,UAAU,CAAC,SAAS;AAAA,QACpB,QAAQ;AAAA,QACR,QAAQ;AAAA,UACP,OAAO;AAAA;AAAA,QAER,UAAU;AAAA,QACV,SAAS;AAAA;AAKV,YAAM,WAAU,QAAQ,QAAQ;AAIhC,UAAI;AACJ,UAAI,OAAO,SAAQ,gBAAgB;AAClC,gBAAQ,MAAM,SAAQ;AAAA;AAGvB,UAAI,OAAO,SAAQ,gBAAgB;AAClC,cAAM,qBAA+C,MAAM,SAAQ,YAAY;AAC/E,cAAM,aAAa,mBAAmB,OAA4B,CAAC,OAAO;AACzE,gBAAM,KAAK,QAAQ;AAAA,YAClB;AAAA,YACA,OAAO,KAAK;AAAA;AAEb,iBAAO;AAAA,WACL;AAEH,YAAI,eAAe;AAClB,qBAAW,CAAC,QAAO,cAAc,OAAO,QAAQ;AAE/C,kBAAM,kBAAiB,CAAE,MAAM,WAAU,UAAU;AACnD,2BAAe,UAAS,CAAE,OAAO,OAAO;AAAA;AAAA;AAI1C,mBAAW,CAAC,QAAO,cAAc,OAAO,QAAQ;AAC/C,gBAAM,UAAU,KAAK,KAAK,QAAQ,WAAW,WAAW,UAAS;AACjE,gBAAM,kBAAiB,CAAE,MAAM,WAAU,UAAU;AACnD,gBAAM,QAAa,CAAE,SAAS,MAAM,QAAO,OAAO,iBAAgB;AAClE,gBAAM,WAAW,SAAS;AAAA;AAE3B;AAAA;AAID,YAAM,QAAQ,MAAM;AACpB,YAAM,iBAAiB,CAAE,MAAM,UAAU;AACzC,qBAAe,SAAS,CAAE,OAAO,OAAO;AAExC,YAAM,OAAa,CAAE,SAAS,KAAK,MAAM,MAAM,MAAM,OAAO,gBAAgB;AAC5E,YAAM,WAAW,SAAS;AAAA;AAI3B,UAAM,qBAAqB,KAAK,KAAK,QAAQ,WAAW,WAAW;AACnE,UAAM,GAAG,UAAU,oBAAoB,KAAK,UAAU,gBAAgB,MAAM,OAAQ;AAAA,WAC5E;AAER,UAAM;AACN,YAAQ,KAAK;AAAA;AAAA;AAIf,IAAI,QAAQ;",
  "names": []
}
